<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to flownet • flownet</title>
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Introduction to flownet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flownet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/flownet" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to flownet</h1>
                        <h4 data-toc-skip class="author">Sebastian
Krantz</h4>
            
            <h4 data-toc-skip class="date">2026-01-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/flownet/blob/master/vignettes/introduction.Rmd" class="external-link"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>flownet</code> package provides efficient tools for
transportation modeling, specifically network processing/preparation,
route enumeration and traffic assignment tasks. The package implements
the <strong>path-sized logit (PSL) model</strong> for traffic
assignment, which accounts for route overlap when assigning traffic
flows to network edges. It can handle directed or undirected graphs, and
it’s network processing functions/algorithms support multimodal
networks. A key design decision was to represent networks graphs using
simple data frames with <code>from</code> and <code>to</code> node
columns. This facilitates applied work, e.g., further manual network
edits such as adding multimodal connector links, and the development of
generalized cost functions using network features.
<!-- This makes it particularly suitable for modeling transport networks where multiple alternative routes may share common segments. --></p>
</div>
<div class="section level2">
<h2 id="getting-started">Getting Started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>Let’s start by loading the required packages and exploring the
example datasets included with <code>flownet</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fastverse.github.io/fastverse/" class="external-link">fastverse</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://fastverse.github.io/fastverse/reference/fastverse_extend.html" class="external-link">fastverse_extend</a></span><span class="op">(</span><span class="va">flownet</span>, <span class="va">sf</span>, <span class="va">tmap</span><span class="op">)</span></span>
<span><span class="fu">tmap_mode</span><span class="op">(</span><span class="st">"plot"</span><span class="op">)</span></span></code></pre></div>
<p>The package includes four example datasets for Africa:</p>
<ul>
<li><p><strong><code>africa_network</code></strong>: A road transport
network with 2,825 LINESTRING features representing existing roads
(2,344 edges) and proposed new links (481 edges). Each edge includes
attributes such as distance, travel duration, border crossing costs,
terrain ruggedness, and road upgrade costs.</p></li>
<li><p><strong><code>africa_cities_ports</code></strong>: 453 African
cities with population &gt; 100,000 and international ports. Includes
population data, capital status, and port cargo outflows.</p></li>
<li><p><strong><code>africa_segments</code></strong>: 14,358 raw network
segments representing intersected road routes. Useful for demonstrating
network consolidation and simplification functions.</p></li>
<li><p><strong><code>africa_trade</code></strong>: Bilateral trade flows
between 47 African countries aggregated by HS section (21 product
categories). Values represent annual averages over 2012-2022.</p></li>
</ul>
<p>The <code>africa_network</code>, <code>africa_cities_ports</code>,
and <code>africa_segments</code> datasets are from Krantz, S. (2024). <a href="https://doi.org/10.1596/1813-9450-10893" class="external-link">Optimal Investments in
Africa’s Road Network</a>. Policy Research Working Paper 10893. World
Bank. Replication materials are available at <a href="https://github.com/SebKrantz/OptimalAfricanRoads" class="external-link">github.com/SebKrantz/OptimalAfricanRoads</a>.</p>
<p>Let’s examine the data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View network structure (existing links only)</span></span>
<span><span class="va">africa_net</span> <span class="op">&lt;-</span> <span class="fu">fsubset</span><span class="op">(</span><span class="va">africa_network</span>, <span class="op">!</span><span class="va">add</span>, <span class="op">-</span><span class="va">add</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">africa_net</span>, max.level <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes 'sf' and 'data.frame':   2344 obs. of  28 variables:</span></span>
<span><span class="co">#&gt;  $ from             : int  1 2 2 2 3 3 4 4 5 5 ...</span></span>
<span><span class="co">#&gt;  $ to               : int  2 3 4 5 4 10 5 17 13 17 ...</span></span>
<span><span class="co">#&gt;  $ from_ctry        : chr  "SEN" "SEN" "SEN" "SEN" ...</span></span>
<span><span class="co">#&gt;  $ to_ctry          : chr  "SEN" "SEN" "SEN" "SEN" ...</span></span>
<span><span class="co">#&gt;  $ FX               : num  -17.4 -17 -17 -17 -16.6 ...</span></span>
<span><span class="co">#&gt;  $ FY               : num  14.7 14.7 14.7 14.7 15.1 ...</span></span>
<span><span class="co">#&gt;  $ TX               : num  -17 -16.6 -16.5 -16.4 -16.5 ...</span></span>
<span><span class="co">#&gt;  $ TY               : num  14.7 15.1 14.8 14.3 14.8 ...</span></span>
<span><span class="co">#&gt;  $ sp_distance      : num  43272 63043 62787 78226 43802 ...</span></span>
<span><span class="co">#&gt;  $ distance         : num  65988 87290 89470 99998 61112 ...</span></span>
<span><span class="co">#&gt;  $ duration         : num  46.1 72.2 61.1 72.9 72.9 ...</span></span>
<span><span class="co">#&gt;  $ speed_kmh        : num  85.8 72.5 87.9 82.3 50.3 ...</span></span>
<span><span class="co">#&gt;  $ passes           : num  104.3 10 1.5 55 1 ...</span></span>
<span><span class="co">#&gt;  $ gravity          : num  215.33 20.138 11.642 122.201 0.526 ...</span></span>
<span><span class="co">#&gt;  $ gravity_rd       : num  157.523 14.738 10.558 88.008 0.395 ...</span></span>
<span><span class="co">#&gt;  $ border_dist      : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ total_dist       : num  65988 87290 89470 99998 61112 ...</span></span>
<span><span class="co">#&gt;  $ border_time      : num  0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;  $ total_time       : num  46.1 72.2 61.1 72.9 72.9 ...</span></span>
<span><span class="co">#&gt;  $ duration_100kmh  : num  39.6 52.4 53.7 60 36.7 ...</span></span>
<span><span class="co">#&gt;  $ total_time_100kmh: num  39.6 52.4 53.7 60 36.7 ...</span></span>
<span><span class="co">#&gt;  $ rugg             : num  25204 23657 25761 24773 11332 ...</span></span>
<span><span class="co">#&gt;  $ pop_wpop         : num  670689 191412 177028 137875 65316 ...</span></span>
<span><span class="co">#&gt;  $ pop_wpop_km2     : num  2263 450 415 262 216 ...</span></span>
<span><span class="co">#&gt;  $ cost_km          : num  699437 605210 607230 581290 520635 ...</span></span>
<span><span class="co">#&gt;  $ upgrade_cat      : chr  "Asphalt Mix Resurfacing" "Mixed Works" "Asphalt Mix Resurfacing" "Asphalt Mix Resurfacing" ...</span></span>
<span><span class="co">#&gt;  $ ug_cost_km       : num  165533 325805 143711 137572 440804 ...</span></span>
<span><span class="co">#&gt;  $ geometry         :sfc_LINESTRING of length 2344; first list element:  'XY' num [1:10, 1:2] -17.4 -17 -17 -17.1 -17.1 ...</span></span>
<span><span class="co">#&gt;  - attr(*, "sf_column")= chr "geometry"</span></span>
<span><span class="co">#&gt;  - attr(*, "agr")= Factor w/ 3 levels "constant","aggregate",..: NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr [1:24] "from" "to" NA NA ...</span></span>
<span></span>
<span><span class="co"># View cities/ports</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">fselect</span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">city</span>, <span class="va">country</span>, <span class="va">population</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 3.3841 ymin: -26.2044 xmax: 39.2803 ymax: 30.0444</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;            city          country population                 geometry</span></span>
<span><span class="co">#&gt; 1         Cairo            Egypt   28621082  POINT (31.2358 30.0444)</span></span>
<span><span class="co">#&gt; 2         Lagos          Nigeria   19932062     POINT (3.3841 6.455)</span></span>
<span><span class="co">#&gt; 3      Kinshasa Congo (Kinshasa)   16579488  POINT (15.3119 -4.3219)</span></span>
<span><span class="co">#&gt; 4        Luanda           Angola   12376210  POINT (13.2344 -8.8383)</span></span>
<span><span class="co">#&gt; 5  Johannesburg     South Africa   12282763 POINT (28.0456 -26.2044)</span></span>
<span><span class="co">#&gt; 6 Dar es Salaam         Tanzania    9048912  POINT (39.2803 -6.8161)</span></span>
<span></span>
<span><span class="co"># View trade data structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">africa_trade</span><span class="op">)</span></span>
<span><span class="co">#&gt;    iso3_o iso3_d section_code</span></span>
<span><span class="co">#&gt;    &lt;fctr&gt; &lt;fctr&gt;        &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    AGO    BDI           16</span></span>
<span><span class="co">#&gt; 2:    AGO    BEN            1</span></span>
<span><span class="co">#&gt; 3:    AGO    BEN            4</span></span>
<span><span class="co">#&gt; 4:    AGO    BEN            5</span></span>
<span><span class="co">#&gt; 5:    AGO    BEN            6</span></span>
<span><span class="co">#&gt; 6:    AGO    BEN            7</span></span>
<span><span class="co">#&gt;                                                                                                                                                                                                   section_name</span></span>
<span><span class="co">#&gt;                                                                                                                                                                                                         &lt;fctr&gt;</span></span>
<span><span class="co">#&gt; 1: Machinery and mechanical appliances, electrical equipment, parts thereof, sound recorders and reproducers, television image and souch recorders and reproducers, and parts and accessories of such articles</span></span>
<span><span class="co">#&gt; 2:                                                                                                                                                                            Live animals and animal products</span></span>
<span><span class="co">#&gt; 3:                                                                                                           Prepared foodstuffs, beverages, spirits and vinegar, tobacco and manufactured tobacco substitutes</span></span>
<span><span class="co">#&gt; 4:                                                                                                                                                                                            Mineral products</span></span>
<span><span class="co">#&gt; 5:                                                                                                                                                               Product of the chemicals or allied industries</span></span>
<span><span class="co">#&gt; 6:                                                                                                                                                  Plastics and articles thereof, rubber and articles thereof</span></span>
<span><span class="co">#&gt;         hs2_codes     value     value_kd  quantity</span></span>
<span><span class="co">#&gt;            &lt;fctr&gt;     &lt;num&gt;        &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:             84    5.1040    5.1040000    0.9870</span></span>
<span><span class="co">#&gt; 2:              3 6810.4528 6527.0068247 8777.0133</span></span>
<span><span class="co">#&gt; 3:     19, 20, 22    9.5135    9.0984152   20.7370</span></span>
<span><span class="co">#&gt; 4:             27 3583.7897 3536.4303649 8369.7665</span></span>
<span><span class="co">#&gt; 5: 30, 32, 33, 34    0.9435    0.9319342    0.0275</span></span>
<span><span class="co">#&gt; 6:         39, 40   71.2590   71.9540899   31.2510</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-workflow-example">Basic Workflow Example<a class="anchor" aria-label="anchor" href="#basic-workflow-example"></a>
</h2>
<p>This section demonstrates a complete workflow from network
preparation to traffic assignment and visualization. We’ll use a
gravity-based OD matrix derived from city populations.</p>
<div class="section level3">
<h3 id="step-1-visualize-the-network">Step 1: Visualize the Network<a class="anchor" aria-label="anchor" href="#step-1-visualize-the-network"></a>
</h3>
<p>First, let’s visualize the network to understand its structure:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot network colored by travel speed</span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"speed_kmh"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"Speed (km/h)"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>,</span>
<span>                                  frame <span class="op">=</span> <span class="cn">FALSE</span>, text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                  item.height <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/visualize-network-1.png" class="r-plt" alt="" width="100%"></p>
</div>
<div class="section level3">
<h3 id="step-2-convert-network-to-graph">Step 2: Convert Network to Graph<a class="anchor" aria-label="anchor" href="#step-2-convert-network-to-graph"></a>
</h3>
<p>The <code><a href="../reference/linestrings_to_graph.html">linestrings_to_graph()</a></code> function converts LINESTRING
geometries to a graph data frame format required for traffic assignment.
In this case, the relevant columns are already provided, thus we only
need to strip the geometry column and turn it into a normal data
frame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert to graph (use atomic_elem to drop sf geometry, qDF for data.frame)</span></span>
<span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu">atomic_elem</span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">qDF</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">graph</span><span class="op">)</span></span>
<span><span class="co">#&gt;   from to from_ctry to_ctry        FX       FY        TX       TY sp_distance</span></span>
<span><span class="co">#&gt; 1    1  2       SEN     SEN -17.44671 14.69281 -17.04453 14.70297    43272.22</span></span>
<span><span class="co">#&gt; 2    2  3       SEN     SEN -17.04453 14.70297 -16.63849 15.11222    63043.01</span></span>
<span><span class="co">#&gt; 3    2  4       SEN     SEN -17.04453 14.70297 -16.46332 14.75651    62786.56</span></span>
<span><span class="co">#&gt; 4    2  5       SEN     SEN -17.04453 14.70297 -16.42054 14.34236    78226.09</span></span>
<span><span class="co">#&gt; 5    3  4       SEN     SEN -16.63849 15.11222 -16.46332 14.75651    43802.37</span></span>
<span><span class="co">#&gt; 6    3 10       SEN     SEN -16.63849 15.11222 -16.24391 15.63569    71956.96</span></span>
<span><span class="co">#&gt;   distance duration speed_kmh   passes     gravity  gravity_rd border_dist</span></span>
<span><span class="co">#&gt; 1  65988.0    46.15  85.79155 104.3333 215.3302926 157.5228265           0</span></span>
<span><span class="co">#&gt; 2  87290.5    72.25  72.49038  10.0000  20.1382178  14.7376257           0</span></span>
<span><span class="co">#&gt; 3  89469.5    61.10  87.85876   1.5000  11.6420372  10.5577017           0</span></span>
<span><span class="co">#&gt; 4  99998.0    72.90  82.30288  55.0000 122.2011739  88.0080152           0</span></span>
<span><span class="co">#&gt; 5  61111.5    72.90  50.29753   1.0000   0.5259515   0.3953356           0</span></span>
<span><span class="co">#&gt; 6  73391.0    61.20  71.95196  31.0000  23.0342955  16.8520354           0</span></span>
<span><span class="co">#&gt;   total_dist border_time total_time duration_100kmh total_time_100kmh      rugg</span></span>
<span><span class="co">#&gt; 1    65988.0           0      46.15         39.5928           39.5928 25203.645</span></span>
<span><span class="co">#&gt; 2    87290.5           0      72.25         52.3743           52.3743 23656.895</span></span>
<span><span class="co">#&gt; 3    89469.5           0      61.10         53.6817           53.6817 25761.240</span></span>
<span><span class="co">#&gt; 4    99998.0           0      72.90         59.9988           59.9988 24773.338</span></span>
<span><span class="co">#&gt; 5    61111.5           0      72.90         36.6669           36.6669 11331.973</span></span>
<span><span class="co">#&gt; 6    73391.0           0      61.20         44.0346           44.0346  1745.889</span></span>
<span><span class="co">#&gt;    pop_wpop pop_wpop_km2  cost_km             upgrade_cat ug_cost_km</span></span>
<span><span class="co">#&gt; 1 670689.38    2262.9802 699437.0 Asphalt Mix Resurfacing   165533.4</span></span>
<span><span class="co">#&gt; 2 191412.11     450.2150 605210.4             Mixed Works   325804.9</span></span>
<span><span class="co">#&gt; 3 177027.86     415.0577 607229.6 Asphalt Mix Resurfacing   143711.0</span></span>
<span><span class="co">#&gt; 4 137874.58     262.0664 581289.6 Asphalt Mix Resurfacing   137571.9</span></span>
<span><span class="co">#&gt; 5  65316.04     216.0512 520634.9                 Upgrade   440804.2</span></span>
<span><span class="co">#&gt; 6 102835.91     212.9464 415457.6             Mixed Works   223654.7</span></span></code></pre></div>
<p>The resulting graph data frame contains: - <code>edge</code>: Edge
identifier (optional) - <code>from</code>, <code>to</code>: Node IDs -
<code>FX</code>, <code>FY</code>, <code>TX</code>, <code>TY</code>: Node
coordinates (optional) - All original columns from the network
(distance, duration, total_time, etc.)</p>
</div>
<div class="section level3">
<h3 id="step-3-extract-nodes-and-map-cities">Step 3: Extract Nodes and Map Cities<a class="anchor" aria-label="anchor" href="#step-3-extract-nodes-and-map-cities"></a>
</h3>
<p>Next, we need to map the city/port locations to the nearest network
nodes:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract nodes with spatial coordinates</span></span>
<span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nodes_from_graph.html">nodes_from_graph</a></span><span class="op">(</span><span class="va">graph</span>, sf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Map cities/ports to nearest nodes</span></span>
<span><span class="va">nearest_nodes</span> <span class="op">&lt;-</span> <span class="va">nodes</span><span class="op">$</span><span class="va">node</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">nodes</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-create-od-matrix">Step 4: Create OD Matrix<a class="anchor" aria-label="anchor" href="#step-4-create-od-matrix"></a>
</h3>
<p>For this example, we’ll create a simple gravity-based OD matrix from
city populations. The <code><a href="../reference/melt_od_matrix.html">melt_od_matrix()</a></code> function converts
the matrix to long format required by <code><a href="../reference/run_assignment.html">run_assignment()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create gravity-based OD matrix (population product scaled down)</span></span>
<span><span class="va">od_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span>, <span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e12</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nearest_nodes</span>, <span class="va">nearest_nodes</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to long format</span></span>
<span><span class="va">od_matrix_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/melt_od_matrix.html">melt_od_matrix</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_matrix_long</span><span class="op">)</span></span>
<span><span class="co">#&gt;   from to       flow</span></span>
<span><span class="co">#&gt; 1    1  1 10.3925963</span></span>
<span><span class="co">#&gt; 2    1  6  0.3804031</span></span>
<span><span class="co">#&gt; 3    1  8  4.6445025</span></span>
<span><span class="co">#&gt; 4    1  8  0.5133217</span></span>
<span><span class="co">#&gt; 5    1  9  0.3426110</span></span>
<span><span class="co">#&gt; 6    1 11  3.1488124</span></span></code></pre></div>
<p>The resulting data frame contains columns <code>from</code>,
<code>to</code>, and <code>flow</code>, with only positive, finite flow
values.</p>
</div>
<div class="section level3">
<h3 id="step-5-run-traffic-assignment">Step 5: Run Traffic Assignment<a class="anchor" aria-label="anchor" href="#step-5-run-traffic-assignment"></a>
</h3>
<p>Now we can run the traffic assignment. The
<code><a href="../reference/run_assignment.html">run_assignment()</a></code> function:</p>
<ul>
<li>Enumerates alternative routes for each OD pair</li>
<li>Computes path probabilities accounting for route overlap (PSL
model)</li>
<li>Assigns flows to network edges</li>
</ul>
<p>For large networks like this one, we’ll use the All-or-Nothing (AoN)
method which is faster:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run Traffic Assignment (All-or-Nothing method for speed)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_assignment.html">run_assignment</a></span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_long</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span>
<span>                         method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Created graph with 1379 nodes and 2344 edges...</span></span>
<span><span class="co">#&gt; 495 OD-pairs have zero or non-finite flow values and will be skipped...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; FlowNet object</span></span>
<span><span class="co">#&gt; Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_long,      cost.column = "duration", method = "AoN", return.extra = "all") </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of nodes: 1379 </span></span>
<span><span class="co">#&gt; Number of edges: 2344 </span></span>
<span><span class="co">#&gt; Number of simulations/OD-pairs: 204714 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average path length in edges (SD): 34.99213  (19.56615)</span></span>
<span><span class="co">#&gt; Average number of visits per edge (SD): 3056.049  (5875.129)</span></span>
<span><span class="co">#&gt; Average path cost (SD): 4345.631  (2253.376)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Final flows summary statistics:</span></span>
<span><span class="co">#&gt;      N  Ndist     Mean       SD  Min       Max  Skew   Kurt</span></span>
<span><span class="co">#&gt;   2344   2017  2187.89  4553.86    0  37250.26  3.49  18.49</span></span>
<span><span class="co">#&gt;   1%  5%   10%    25%     50%      75%   90%       95%       99%</span></span>
<span><span class="co">#&gt;    0   0  1.08  36.57  295.39  1662.86  7581  11386.38  20188.24</span></span></code></pre></div>
<p>Key parameters: - <code>cost.column</code>: The cost column to use
for route computation (here “duration” in minutes) -
<code>method</code>: “PSL” (path-sized logit) or “AoN” (all-or-nothing)
- <code>return.extra</code>: Additional results to return (“all” returns
everything)</p>
</div>
<div class="section level3">
<h3 id="step-6-visualize-results">Step 6: Visualize Results<a class="anchor" aria-label="anchor" href="#step-6-visualize-results"></a>
</h3>
<p>Finally, we can visualize the assigned flows on the network:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add flows to network for visualization</span></span>
<span><span class="va">africa_net</span><span class="op">$</span><span class="va">final_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"final_flows_log10"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"brewer.yl_or_rd"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"Log10 Flows"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>,</span>
<span>                                  frame <span class="op">=</span> <span class="cn">FALSE</span>, text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_dots</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.15</span>, fill <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/visualize-results-1.png" class="r-plt" alt="" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-workflow-trade-flow-disaggregation">Advanced Workflow: Trade Flow Disaggregation<a class="anchor" aria-label="anchor" href="#advanced-workflow-trade-flow-disaggregation"></a>
</h2>
<p>For more realistic modeling, we can disaggregate country-level trade
flows to city-level using population shares. This approach distributes
trade between countries across their respective cities proportionally to
population.</p>
<div class="section level3">
<h3 id="step-1-compute-city-population-shares">Step 1: Compute City Population Shares<a class="anchor" aria-label="anchor" href="#step-1-compute-city-population-shares"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute each city's share of its country's population</span></span>
<span><span class="va">city_pop</span> <span class="op">&lt;-</span> <span class="va">africa_cities_ports</span> <span class="op">|&gt;</span> <span class="fu">atomic_elem</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">qDF</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fcompute</span><span class="op">(</span>node <span class="op">=</span> <span class="va">nearest_nodes</span>,</span>
<span>           city <span class="op">=</span> <span class="fu">qF</span><span class="op">(</span><span class="va">city_country</span><span class="op">)</span>,</span>
<span>           pop_share <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">population</span>, <span class="va">iso3</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>,</span>
<span>           keep <span class="op">=</span> <span class="st">"iso3"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">city_pop</span><span class="op">)</span></span>
<span><span class="co">#&gt;   iso3 node                        city pop_share</span></span>
<span><span class="co">#&gt; 1  EGY  937               Cairo - Egypt 0.6554678</span></span>
<span><span class="co">#&gt; 2  NGA  289             Lagos - Nigeria 0.3860030</span></span>
<span><span class="co">#&gt; 3  COD  635 Kinshasa - Congo (Kinshasa) 0.4784988</span></span>
<span><span class="co">#&gt; 4  AGO  577             Luanda - Angola 0.5361630</span></span>
<span><span class="co">#&gt; 5  ZAF  913 Johannesburg - South Africa 0.4947698</span></span>
<span><span class="co">#&gt; 6  TZA 1296    Dar es Salaam - Tanzania 0.6238426</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-disaggregate-trade-flows">Step 2: Disaggregate Trade Flows<a class="anchor" aria-label="anchor" href="#step-2-disaggregate-trade-flows"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregate trade to country-country level (sum across HS sections)</span></span>
<span><span class="va">trade_agg</span> <span class="op">&lt;-</span> <span class="va">africa_trade</span> <span class="op">|&gt;</span> <span class="fu">collap</span><span class="op">(</span><span class="va">quantity</span> <span class="op">~</span> <span class="va">iso3_o</span> <span class="op">+</span> <span class="va">iso3_d</span>, <span class="va">fsum</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join with city population shares for origin and destination</span></span>
<span><span class="co"># add_stub adds suffix to all columns, so iso3 -&gt; iso3_o matches trade_agg$iso3_o</span></span>
<span><span class="va">od_matrix_trade</span> <span class="op">&lt;-</span> <span class="va">trade_agg</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">join</span><span class="op">(</span><span class="va">city_pop</span> <span class="op">|&gt;</span> <span class="fu">add_stub</span><span class="op">(</span><span class="st">"_o"</span>, <span class="cn">FALSE</span><span class="op">)</span>, multiple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">join</span><span class="op">(</span><span class="va">city_pop</span> <span class="op">|&gt;</span> <span class="fu">add_stub</span><span class="op">(</span><span class="st">"_d"</span>, <span class="cn">FALSE</span><span class="op">)</span>, multiple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fmutate</span><span class="op">(</span>flow <span class="op">=</span> <span class="va">quantity</span> <span class="op">*</span> <span class="va">pop_share_o</span> <span class="op">*</span> <span class="va">pop_share_d</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">frename</span><span class="op">(</span>from <span class="op">=</span> <span class="va">node_o</span>, to <span class="op">=</span> <span class="va">node_d</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fsubset</span><span class="op">(</span><span class="va">flow</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">from</span> <span class="op">!=</span> <span class="va">to</span><span class="op">)</span></span>
<span><span class="co">#&gt; left join: trade_agg[iso3_o] 1971/1971 (100%) &lt;41.94:9.62&gt; y[iso3_o] 452/453 (99.8%)</span></span>
<span><span class="co">#&gt; left join: x[iso3_d] 19685/19685 (100%) &lt;418.83:9.62&gt; y[iso3_d] 452/453 (99.8%)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_matrix_trade</span><span class="op">)</span></span>
<span><span class="co">#&gt;    iso3_o iso3_d quantity  from            city_o pop_share_o    to</span></span>
<span><span class="co">#&gt;    &lt;fctr&gt; &lt;fctr&gt;    &lt;num&gt; &lt;int&gt;            &lt;fctr&gt;       &lt;num&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:    AGO    BDI    0.987   577   Luanda - Angola  0.53616303   962</span></span>
<span><span class="co">#&gt; 2:    AGO    BDI    0.987   550  Lubango - Angola  0.03794550   962</span></span>
<span><span class="co">#&gt; 3:    AGO    BDI    0.987   540  Cabinda - Angola  0.03202289   962</span></span>
<span><span class="co">#&gt; 4:    AGO    BDI    0.987   613   Huambo - Angola  0.02883361   962</span></span>
<span><span class="co">#&gt; 5:    AGO    BDI    0.987   645  Malanje - Angola  0.02843812   962</span></span>
<span><span class="co">#&gt; 6:    AGO    BDI    0.987   549 Benguela - Angola  0.05153641   962</span></span>
<span><span class="co">#&gt;                 city_d pop_share_d       flow</span></span>
<span><span class="co">#&gt;                 &lt;fctr&gt;       &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Bujumbura - Burundi           1 0.52919291</span></span>
<span><span class="co">#&gt; 2: Bujumbura - Burundi           1 0.03745221</span></span>
<span><span class="co">#&gt; 3: Bujumbura - Burundi           1 0.03160660</span></span>
<span><span class="co">#&gt; 4: Bujumbura - Burundi           1 0.02845877</span></span>
<span><span class="co">#&gt; 5: Bujumbura - Burundi           1 0.02806843</span></span>
<span><span class="co">#&gt; 6: Bujumbura - Burundi           1 0.05086644</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-run-assignment-with-trade-flows">Step 3: Run Assignment with Trade Flows<a class="anchor" aria-label="anchor" href="#step-3-run-assignment-with-trade-flows"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run Traffic Assignment with trade-based OD matrix</span></span>
<span><span class="va">result_trade</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_assignment.html">run_assignment</a></span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_trade</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span>
<span>                               method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Created graph with 1379 nodes and 2344 edges...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_trade</span><span class="op">)</span></span>
<span><span class="co">#&gt; FlowNet object</span></span>
<span><span class="co">#&gt; Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_trade,      cost.column = "duration", method = "AoN", return.extra = "all") </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of nodes: 1379 </span></span>
<span><span class="co">#&gt; Number of edges: 2344 </span></span>
<span><span class="co">#&gt; Number of simulations/OD-pairs: 189020 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average path length in edges (SD): 36.15387  (19.23456)</span></span>
<span><span class="co">#&gt; Average number of visits per edge (SD): 2915.445  (5685.838)</span></span>
<span><span class="co">#&gt; Average path cost (SD): 4477.602  (2187.799)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Final flows summary statistics:</span></span>
<span><span class="co">#&gt;      N  Ndist         Mean           SD  Min          Max  Skew   Kurt</span></span>
<span><span class="co">#&gt;   2344   1864  1'273306.07  2'915489.75    0  21'964576.8   3.7  18.51</span></span>
<span><span class="co">#&gt;   1%  5%  10%       25%        50%        75%          90%          95%</span></span>
<span><span class="co">#&gt;    0   0    0  17330.95  142839.71  911817.37  3'624008.55  6'948734.38</span></span>
<span><span class="co">#&gt;           99%</span></span>
<span><span class="co">#&gt;   14'969459.2</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add flows to network for visualization</span></span>
<span><span class="va">africa_net</span><span class="op">$</span><span class="va">final_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result_trade</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"final_flows_log10"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"brewer.yl_or_rd"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"Log10 Trade Flows"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>,</span>
<span>                                  frame <span class="op">=</span> <span class="cn">FALSE</span>, text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_dots</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.15</span>, fill <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/visualize-results-trade-1.png" class="r-plt" alt="" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-workflow-with-network-consolidation">Advanced Workflow with Network Consolidation<a class="anchor" aria-label="anchor" href="#advanced-workflow-with-network-consolidation"></a>
</h2>
<p>For large or complex networks, it’s often beneficial to consolidate
the graph by removing intermediate nodes and merging edges. This
simplifies the network topology while preserving connectivity, which can
significantly improve computational performance.</p>
<div class="section level3">
<h3 id="using-raw-segments">Using Raw Segments<a class="anchor" aria-label="anchor" href="#using-raw-segments"></a>
</h3>
<p>The <code>africa_segments</code> dataset provides raw network
segments that can be processed through the full consolidation workflow.
It was obtained by computing fastest car routes between all of the 453
African (port-)cities that are less than 2000km apart using <a href="https://cran.r-project.org/package=osrm" class="external-link">osrm</a>, feeding them
through <a href="https://docs.ropensci.org/stplanr/reference/overline.html" class="external-link"><code>stplanr::overline()</code></a>
and <a href="https://andyteucher.ca/rmapshaper/reference/ms_simplify.html" class="external-link"><code>rmapshaper::ms_simplify()</code></a>,
and then just taking the start and end coordinate of each segment. The
final network <code>africa_network</code> used above was created using
these segments in a similar way to how I will demonstrate below
(consolidation followed by clustering simplification + a <a href="https://cran.r-project.org/package=osrm" class="external-link">osrm</a> to get
simplified edge geometries).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert segments to sf and then to graph</span></span>
<span><span class="va">graph_seg</span> <span class="op">&lt;-</span> <span class="va">africa_segments</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/linestrings_to_graph.html">linestrings_to_graph</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_undirected_graph.html">create_undirected_graph</a></span><span class="op">(</span>FUN <span class="op">=</span> <span class="st">"fsum"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get nodes and map cities</span></span>
<span><span class="va">nodes_seg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nodes_from_graph.html">nodes_from_graph</a></span><span class="op">(</span><span class="va">graph_seg</span>, sf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">nearest_nodes_seg</span> <span class="op">&lt;-</span> <span class="va">nodes_seg</span><span class="op">$</span><span class="va">node</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">nodes_seg</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original segments:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_seg</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original segments: 11385</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="consolidate-graph">Consolidate Graph<a class="anchor" aria-label="anchor" href="#consolidate-graph"></a>
</h3>
<p>The <code><a href="../reference/consolidate_graph.html">consolidate_graph()</a></code> function recursively removes
intermediate nodes (nodes that occur exactly twice) and merges
connecting edges. At each step, network attributes are aggregated using
<a href="https://fastverse.org/collapse/reference/collap.html" class="external-link"><code>collap()</code></a>,
which, by default uses the mean for numeric and the statistical mode for
categorical attributes (columns), and supports weights (here the number
of passes through a segment along different routes generated by <a href="https://docs.ropensci.org/stplanr/reference/overline.html" class="external-link"><code>stplanr::overline()</code></a>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Consolidate graph, preserving city nodes</span></span>
<span><span class="va">graph_cons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consolidate_graph.html">consolidate_graph</a></span><span class="op">(</span><span class="va">graph_seg</span>,</span>
<span>                                keep <span class="op">=</span> <span class="va">nearest_nodes_seg</span>,</span>
<span>                                w <span class="op">=</span> <span class="op">~</span> <span class="va">passes</span><span class="op">)</span></span>
<span><span class="co">#&gt; Consolidating undirected graph graph_seg with 11385 edges using full recursion</span></span>
<span><span class="co">#&gt; Initial node degrees:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5    6    7    8    9   10 </span></span>
<span><span class="co">#&gt;  125 5293 3240  395  102   31    4    2    1    1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dropped 44 loop edges</span></span>
<span><span class="co">#&gt; Dropped 11 edges leading to singleton nodes</span></span>
<span><span class="co">#&gt; Oriented 3431 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 5079 intermediate nodes</span></span>
<span><span class="co">#&gt; Oriented 10 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 10 intermediate nodes</span></span>
<span><span class="co">#&gt; Aggregated 11330 edges down to 6597 edges</span></span>
<span><span class="co">#&gt; Oriented 361 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 375 intermediate nodes</span></span>
<span><span class="co">#&gt; Oriented 8 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 8 intermediate nodes</span></span>
<span><span class="co">#&gt; Aggregated 6597 edges down to 6264 edges</span></span>
<span><span class="co">#&gt; Oriented 41 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 43 intermediate nodes</span></span>
<span><span class="co">#&gt; Oriented 1 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 1 intermediate nodes</span></span>
<span><span class="co">#&gt; Aggregated 6264 edges down to 6224 edges</span></span>
<span><span class="co">#&gt; Oriented 2 undirected intermediate edges</span></span>
<span><span class="co">#&gt; Consolidated 3 intermediate nodes</span></span>
<span><span class="co">#&gt; Aggregated 6224 edges down to 6221 edges</span></span>
<span><span class="co">#&gt; No nodes to consolidate, returning graph</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Consolidated undirected graph graph_seg from 11385 edges to 6221 edges (54.6%)</span></span>
<span><span class="co">#&gt; Final node degrees:</span></span>
<span><span class="co">#&gt;    1    2    3    4    5    6    7    8 </span></span>
<span><span class="co">#&gt;  114  236 3246  392   84   18    2    1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"After consolidation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_cons</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; After consolidation: 6221</span></span></code></pre></div>
<p>The use of <code>keep</code> here indicates node IDs to preserve
(city/port closest nodes).</p>
</div>
<div class="section level3">
<h3 id="compare-original-vs-consolidated-network">Compare Original vs Consolidated Network<a class="anchor" aria-label="anchor" href="#compare-original-vs-consolidated-network"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="va">graph_seg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"passes"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"N. Passes"</span>,</span>
<span>                                  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_title</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Original:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_seg</span><span class="op">)</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/compare-networks-1.png" class="r-plt" alt="" width="100%"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="va">graph_cons</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"passes"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"N. Passes"</span>,</span>
<span>                                  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_title</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Consolidated:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_cons</span><span class="op">)</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/compare-networks-cons-1.png" class="r-plt" alt="" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="network-simplification-with-simplify_network">Network Simplification with <code>simplify_network()</code><a class="anchor" aria-label="anchor" href="#network-simplification-with-simplify_network"></a>
</h2>
<p>While <code><a href="../reference/consolidate_graph.html">consolidate_graph()</a></code> already simplifies the network
topography preserving full connectivity, the
<code><a href="../reference/simplify_network.html">simplify_network()</a></code> function provides two methods for
further reducing network complexity while preserving connectivity
between important nodes:</p>
<ol style="list-style-type: decimal">
<li>
<strong>shortest-paths</strong>: Keeps only edges traversed by
shortest paths between specified nodes</li>
<li>
<strong>cluster</strong>: Spatially clusters nodes using the
<code>leaderCluster</code> algorithm and contracts the graph</li>
</ol>
<div class="section level3">
<h3 id="shortest-paths-method">Shortest-Paths Method<a class="anchor" aria-label="anchor" href="#shortest-paths-method"></a>
</h3>
<p>This method computes shortest paths between all specified nodes and
retains only the traversed edges:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simplify network using shortest paths</span></span>
<span><span class="va">graph_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simplify_network.html">simplify_network</a></span><span class="op">(</span><span class="va">graph_cons</span>, <span class="va">nearest_nodes_seg</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"shortest-paths"</span>,</span>
<span>                                 cost.column <span class="op">=</span> <span class="st">"length"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Consolidated edges:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_cons</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Consolidated edges: 6221</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Simplified edges:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_simple</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simplified edges: 4858</span></span>
<span></span>
<span><span class="co"># Visualize</span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="va">graph_simple</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"passes"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"N. Passes"</span>,</span>
<span>                                  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_title</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Simplified (SP):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_simple</span><span class="op">)</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/simplify-shortest-paths-1.png" class="r-plt" alt="" width="100%"></p>
</div>
<div class="section level3">
<h3 id="cluster-method">Cluster Method<a class="anchor" aria-label="anchor" href="#cluster-method"></a>
</h3>
<p>The cluster method uses the <code>leaderCluster</code> algorithm to
spatially group nearby nodes and contract the graph. This is useful for
creating coarser network representations:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute node weights for clustering (sum of gravity at each node)</span></span>
<span><span class="va">node_weights</span> <span class="op">&lt;-</span> <span class="fu">rowbind</span><span class="op">(</span></span>
<span>  <span class="fu">fselect</span><span class="op">(</span><span class="va">graph_cons</span>, node <span class="op">=</span> <span class="va">from</span>, <span class="va">gravity_rd</span><span class="op">)</span>,</span>
<span>  <span class="fu">fselect</span><span class="op">(</span><span class="va">graph_cons</span>, <span class="va">to</span>, <span class="va">gravity_rd</span><span class="op">)</span>,use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">collap</span><span class="op">(</span><span class="op">~</span> <span class="va">node</span>, <span class="va">fsum</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cluster-based simplification</span></span>
<span><span class="va">graph_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simplify_network.html">simplify_network</a></span><span class="op">(</span><span class="va">graph_cons</span>, <span class="va">nearest_nodes_seg</span>,</span>
<span>                                  method <span class="op">=</span> <span class="st">"cluster"</span>,</span>
<span>                                  cost.column <span class="op">=</span> <span class="va">node_weights</span><span class="op">$</span><span class="va">gravity_rd</span>,</span>
<span>                                  radius_km <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nodes <span class="op">=</span> <span class="fl">30</span>, cluster <span class="op">=</span> <span class="fl">27</span><span class="op">)</span>,</span>
<span>                                  w <span class="op">=</span> <span class="op">~</span> <span class="va">passes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Clustered edges:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_cluster</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Clustered edges: 2430</span></span>
<span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="va">graph_cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"passes"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"viridis"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"N. Passes"</span>,</span>
<span>                                  position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>, frame <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_title</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Simplified (CL):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">graph_cluster</span><span class="op">)</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/simplify-cluster-1.png" class="r-plt" alt="" width="100%"></p>
<p>Key cluster parameters:</p>
<ul>
<li>
<code>radius_km$nodes</code>: Radius (km) around preserved nodes to
assign nearby nodes</li>
<li>
<code>radius_km$cluster</code>: Clustering radius (km) for remaining
nodes</li>
</ul>
<p>Let’s see if we can assign to this network:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nearest_nodes_seg</span>, <span class="va">nearest_nodes_seg</span><span class="op">)</span></span>
<span><span class="va">od_matrix_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/melt_od_matrix.html">melt_od_matrix</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run Traffic Assignment with trade-based OD matrix</span></span>
<span><span class="va">result_cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_assignment.html">run_assignment</a></span><span class="op">(</span><span class="va">graph_cluster</span>, <span class="va">od_matrix_long</span>, cost.column <span class="op">=</span> <span class="st">".length"</span>,</span>
<span>                            method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Created graph with 1448 nodes and 2430 edges...</span></span>
<span><span class="co">#&gt; 455 OD-pairs have zero or non-finite flow values and will be skipped...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_cl</span><span class="op">)</span></span>
<span><span class="co">#&gt; FlowNet object</span></span>
<span><span class="co">#&gt; Call: run_assignment(graph_df = graph_cluster, od_matrix_long = od_matrix_long,      cost.column = ".length", method = "AoN", return.extra = "all") </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of nodes: 1448 </span></span>
<span><span class="co">#&gt; Number of edges: 2430 </span></span>
<span><span class="co">#&gt; Number of simulations/OD-pairs: 204754 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Average path length in edges (SD): 38.05575  (20.70196)</span></span>
<span><span class="co">#&gt; Average number of visits per edge (SD): 3206.612  (7020.48)</span></span>
<span><span class="co">#&gt; Average path cost (SD): 1687373  (835562.6)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Final flows summary statistics:</span></span>
<span><span class="co">#&gt;      N  Ndist     Mean      SD  Min       Max  Skew   Kurt</span></span>
<span><span class="co">#&gt;   2430   1487  2314.72  5466.4    0  38831.84  3.45  16.16</span></span>
<span><span class="co">#&gt;   1%  5%  10%   25%    50%      75%      90%       95%      99%</span></span>
<span><span class="co">#&gt;    0   0    0  0.18  136.3  1444.91  7877.63  14665.89  27837.5</span></span>
<span></span>
<span><span class="co"># Add flows to network for visualization</span></span>
<span><span class="va">graph_cluster</span><span class="op">$</span><span class="va">final_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result_cl</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tm_basemap</span><span class="op">(</span><span class="st">"CartoDB.Positron"</span>, zoom <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="fu"><a href="../reference/linestrings_from_graph.html">linestrings_from_graph</a></span><span class="op">(</span><span class="va">graph_cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">tm_lines</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"final_flows_log10"</span>,</span>
<span>           col.scale <span class="op">=</span> <span class="fu">tm_scale_continuous</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"brewer.yl_or_rd"</span><span class="op">)</span>,</span>
<span>           col.legend <span class="op">=</span> <span class="fu">tm_legend</span><span class="op">(</span><span class="st">"Log10 Flows"</span>, position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span>,</span>
<span>                                  frame <span class="op">=</span> <span class="cn">FALSE</span>, text.size <span class="op">=</span> <span class="fl">0.8</span>, title.size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_shape</span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">)</span> <span class="op">+</span> <span class="fu">tm_dots</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.15</span>, fill <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">tm_layout</span><span class="op">(</span>frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/simplify-cluster-assign-1.png" class="r-plt" alt="" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="key-concepts-and-functions">Key Concepts and Functions<a class="anchor" aria-label="anchor" href="#key-concepts-and-functions"></a>
</h2>
<p>The above overview showcased essential package functions. The
Path-Sized Logit (PSL) assignment model was not used as it should take a
few minutes to process around 200k OD-pairs with the PSL, minding that a
selection of routes must be generated for each OD pairs. PSL flow
assignments are smoother/more distributed, and more realistic than the
all-or-nothing method which assigns the entire flow to the shortest path
without regard for alternative routes.</p>
<p>The remainder of this vignette provides a theoretical overview of the
PSL model, followed by a summary of the key functions of this
package.</p>
<div class="section level3">
<h3 id="path-sized-logit-model">Path-Sized Logit Model<a class="anchor" aria-label="anchor" href="#path-sized-logit-model"></a>
</h3>
<p>The <strong>Path-Sized Logit (PSL)</strong> model is a discrete
choice model used for traffic assignment that overcomes the independence
of irrelevant alternatives (IIA) property of the standard Multinomial
Logit (MNL) model. In transport networks, alternative routes often
overlap significantly, sharing common edges. The MNL model treats these
overlapping routes as independent, leading to an overestimation of flow
on shared segments.</p>
<p>The PSL model introduces a <strong>correction term</strong>
(path-size factor) to the utility function of each route, penalizing
paths that share links with other alternatives.</p>
<div class="section level4">
<h4 id="probability-formula">Probability Formula<a class="anchor" aria-label="anchor" href="#probability-formula"></a>
</h4>
<p>The probability <span class="math inline">P_k</span> of choosing
route <span class="math inline">k</span> from the set of alternative
routes <span class="math inline">K</span> is given by:</p>
<p><span class="math display">P_k = \frac{e^{V_k}}{\sum_{j \in K}
e^{V_j}}</span></p>
<p>where <span class="math inline">V_k</span> is the deterministic
utility of route <span class="math inline">k</span>, defined in
<code>flownet</code> as:</p>
<p><span class="math display">V_k = -C_k + \beta_{PSL}
\ln(PS_k)</span></p>
<p>Here: - <span class="math inline">C_k</span> is the generalized cost
of route <span class="math inline">k</span>. - <span class="math inline">\beta_{PSL}</span> is the path-sized logit parameter
(controlled by the <code>beta</code> argument). - <span class="math inline">PS_k</span> is the <strong>Path-Size factor</strong>
for route <span class="math inline">k</span>.</p>
</div>
<div class="section level4">
<h4 id="the-correction-term-path-size-factor-ps_k">The Correction Term: Path-Size Factor (<span class="math inline">PS_k</span>)<a class="anchor" aria-label="anchor" href="#the-correction-term-path-size-factor-ps_k"></a>
</h4>
<p>The Path-Size factor <span class="math inline">PS_k</span> quantifies
the uniqueness of route <span class="math inline">k</span>. It is
defined as the ratio of the length (or cost) of the links in path <span class="math inline">k</span> to the number of alternatives sharing those
links. The formula implemented in <code>flownet</code> is:</p>
<p><span class="math display">PS_k = \frac{1}{C_k} \sum_{a \in \Gamma_k}
\frac{c_a}{\delta_a}</span></p>
<p>Where: - <span class="math inline">\Gamma_k</span> is the set of
edges in path <span class="math inline">k</span>. - <span class="math inline">c_a</span> is the cost of edge <span class="math inline">a</span>. - <span class="math inline">C_k = \sum_{a
\in \Gamma_k} c_a</span> is the total cost of path <span class="math inline">k</span>. - <span class="math inline">\delta_a</span> is the number of alternative routes
in the choice set <span class="math inline">K</span> that use edge <span class="math inline">a</span>.</p>
<p><strong>Interpretation:</strong> - If a path is completely unique
(<span class="math inline">\delta_a = 1</span> for all edges), then
<span class="math inline">PS_k = 1</span> and <span class="math inline">\ln(PS_k) = 0</span>. The utility reduces to the
standard MNL utility (<span class="math inline">V_k = -C_k</span>). - If
a path shares edges with many other routes (<span class="math inline">\delta_a &gt; 1</span>), then <span class="math inline">PS_k &lt; 1</span> and <span class="math inline">\ln(PS_k) &lt; 0</span>. - The term <span class="math inline">\beta_{PSL} \ln(PS_k)</span> acts as a correction.
Since <span class="math inline">\ln(PS_k)</span> is negative for
overlapping routes, a <strong>positive</strong> <span class="math inline">\beta_{PSL}</span> (default 1) is required to ensure
that overlapping paths have lower utility (penalization).</p>
<p>This formulation ensures that the model assigns lower probabilities
to routes that are largely duplicates of others, distributing flow more
realistically across truly distinct alternatives. In practice, a value
of <span class="math inline">\beta_{PSL} = 1</span> is a sensible
default; higher values strengthen the penalization of overlapping routes
and lower values make the model behave more like a standard MNL.</p>
</div>
</div>
<div class="section level3">
<h3 id="network-processing-functions">Network Processing Functions<a class="anchor" aria-label="anchor" href="#network-processing-functions"></a>
</h3>
<p><strong><code><a href="../reference/linestrings_to_graph.html">linestrings_to_graph()</a></code></strong>: Converts
LINESTRING geometries to a graph data frame format. This is typically
the first step when working with spatial network data.</p>
<p><strong><code><a href="../reference/linestrings_from_graph.html">linestrings_from_graph()</a></code></strong>: Converts a
graph data frame back to LINESTRING geometries. Useful for visualization
and spatial operations.</p>
<p><strong><code><a href="../reference/create_undirected_graph.html">create_undirected_graph()</a></code></strong>: Converts a
directed graph to an undirected graph by normalizing edge directions and
aggregating duplicate connections. Useful when transport links can be
traversed in both directions.</p>
<p><strong><code><a href="../reference/consolidate_graph.html">consolidate_graph()</a></code></strong>: Simplifies network
topology by removing intermediate nodes and merging connecting edges.
This can significantly reduce computational complexity while preserving
connectivity.</p>
<p><strong><code><a href="../reference/simplify_network.html">simplify_network()</a></code></strong>: Simplifies the
network using one of two methods:</p>
<ul>
<li>
<strong>shortest-paths</strong>: Keeps only edges traversed by
shortest paths between specified nodes</li>
<li>
<strong>cluster</strong>: Spatially clusters nodes using the
<code>leaderCluster</code> algorithm and contracts the graph</li>
</ul>
</div>
<div class="section level3">
<h3 id="graph-utilities">Graph Utilities<a class="anchor" aria-label="anchor" href="#graph-utilities"></a>
</h3>
<p><strong><code><a href="../reference/nodes_from_graph.html">nodes_from_graph()</a></code></strong>: Extracts unique
nodes with coordinates from a graph. Essential for mapping zone
centroids to network nodes.</p>
<p><strong><code><a href="../reference/normalize_graph.html">normalize_graph()</a></code></strong>: Normalizes node IDs
to consecutive integers starting from 1. This can improve performance
with some graph algorithms.</p>
<p><strong><code><a href="../reference/distances_from_graph.html">distances_from_graph()</a></code></strong>: Computes a
distance matrix for all node pairs using the graph structure.</p>
</div>
<div class="section level3">
<h3 id="od-matrix-utilities">OD Matrix Utilities<a class="anchor" aria-label="anchor" href="#od-matrix-utilities"></a>
</h3>
<p><strong><code><a href="../reference/melt_od_matrix.html">melt_od_matrix()</a></code></strong>: Converts an
origin-destination matrix to long format with columns <code>from</code>,
<code>to</code>, and <code>flow</code>. This format is required by
<code><a href="../reference/run_assignment.html">run_assignment()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="traffic-assignment">Traffic Assignment<a class="anchor" aria-label="anchor" href="#traffic-assignment"></a>
</h3>
<p><strong><code><a href="../reference/run_assignment.html">run_assignment()</a></code></strong>: The core function for
traffic assignment. Key parameters:</p>
<ul>
<li>
<strong><code>method</code></strong>: “PSL” (path-sized logit) or
“AoN” (all-or-nothing). AoN is faster but doesn’t account for route
overlap.</li>
<li>
<strong><code>beta</code></strong> (default: 1): Path-sized logit
parameter. A positive value penalizes overlapping routes.</li>
<li>
<strong><code>detour.max</code></strong> (default: 1.5): Maximum
detour factor for alternative routes. Higher values consider more routes
but increase computation time substantially.</li>
<li>
<strong><code>angle.max</code></strong> (default: 90): Maximum
detour angle in degrees. Routes outside this angle from the straight
line between origin and destination are not considered.</li>
<li>
<strong><code>cost.column</code></strong>: The cost column to use
for route computation. Can be a column name or numeric vector.</li>
<li>
<strong><code>return.extra</code></strong>: Additional results to
return, such as paths, edge counts, or distance matrices.</li>
</ul>
</div>
<div class="section level3">
<h3 id="parameter-tuning-tips">Parameter Tuning Tips<a class="anchor" aria-label="anchor" href="#parameter-tuning-tips"></a>
</h3>
<ul>
<li>
<strong><code>detour.max</code></strong>: Start with the default
(1.5) and increase if you need to consider more alternative routes. Be
aware that higher values can dramatically increase computation
time.</li>
<li>
<strong><code>angle.max</code></strong>: Use this to restrict route
enumeration to more direct paths. Smaller values (e.g., 45°) can
significantly speed up computation for large networks.</li>
<li>
<strong><code>beta</code></strong>: The path-sized logit parameter.
Typically positive (default 1) to penalize route overlap; values larger
than 1 increase the penalty on overlapping routes, and values between 0
and 1 make the model closer to a standard MNL.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette has demonstrated the basic and advanced workflows for
using the <code>flownet</code> package:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Basic workflow</strong>: Convert network to graph, map zones
to nodes, create OD matrix, and run traffic assignment</li>
<li>
<strong>Trade flow disaggregation</strong>: Distribute country-level
trade to city-level flows using population shares</li>
<li>
<strong>Network consolidation</strong>: Process raw segments through
consolidation and simplification for efficient computation</li>
</ol>
<p>The package provides efficient tools for transport modeling with the
path-sized logit model, accounting for route overlap in traffic
assignment. The network processing utilities allow you to prepare and
simplify networks for efficient computation.</p>
<div class="section level3">
<h3 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h3>
<ul>
<li>Explore the full function documentation:
<code>?flownet-package</code>
</li>
<li>Experiment with different parameter values (<code>beta</code>,
<code>detour.max</code>, <code>angle.max</code>)</li>
<li>Try the PSL method instead of AoN for smaller networks or
subsets</li>
<li>Use <code>africa_trade</code> to explore trade patterns by different
HS sections</li>
<li>Experiment with <code><a href="../reference/simplify_network.html">simplify_network()</a></code> cluster method for
coarser network representations</li>
</ul>
<p>For more information, see the package documentation and examples in
the help files for individual functions.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
