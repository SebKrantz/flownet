<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run Traffic Assignment — run_assignment • flownet</title><!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Run Traffic Assignment — run_assignment"><meta name="description" content="Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods."><meta property="og:description" content="Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flownet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/flownet" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Run Traffic Assignment</h1>
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/flownet/blob/master/R/assignment.R" class="external-link"><code>R/assignment.R</code></a></small>
      <div class="d-none name"><code>run_assignment.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_assignment</span><span class="op">(</span></span>
<span>  <span class="va">graph_df</span>,</span>
<span>  <span class="va">od_matrix_long</span>,</span>
<span>  directed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cost.column <span class="op">=</span> <span class="st">"cost"</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PSL"</span>, <span class="st">"AoN"</span><span class="op">)</span>,</span>
<span>  beta <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  detour.max <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  angle.max <span class="op">=</span> <span class="fl">90</span>,</span>
<span>  unique.cost <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  npaths.max <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  dmat.max.size <span class="op">=</span> <span class="fl">10000</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>  return.extra <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nthreads <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'flownet'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-graph-df">graph_df<a class="anchor" aria-label="anchor" href="#arg-graph-df"></a></dt>
<dd><p>A data.frame with columns <code>from</code>, <code>to</code>, and optionally a cost column.
Represents the network graph with edges between nodes.</p></dd>


<dt id="arg-od-matrix-long">od_matrix_long<a class="anchor" aria-label="anchor" href="#arg-od-matrix-long"></a></dt>
<dd><p>A data.frame with columns <code>from</code>, <code>to</code>, and <code>flow</code>.
Represents the origin-destination matrix in long format with flow values.</p></dd>


<dt id="arg-directed">directed<a class="anchor" aria-label="anchor" href="#arg-directed"></a></dt>
<dd><p>Logical (default: FALSE). Whether the graph is directed.</p></dd>


<dt id="arg-cost-column">cost.column<a class="anchor" aria-label="anchor" href="#arg-cost-column"></a></dt>
<dd><p>Character string (default: "cost") or numeric vector. Name of the cost column
in <code>graph_df</code>, or a numeric vector of edge costs with length equal to <code>nrow(graph_df)</code>.
The cost values are used to compute shortest paths and determine route probabilities.</p></dd>


<dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>Character string (default: "PSL"). Assignment method:</p><ul><li><p><code>"PSL"</code>: Path-Sized Logit model considering multiple routes with overlap correction</p></li>
<li><p><code>"AoN"</code>: All-or-Nothing assignment, assigns all flow to the shortest path (faster but no route alternatives)</p></li>
</ul></dd>


<dt id="arg-beta">beta<a class="anchor" aria-label="anchor" href="#arg-beta"></a></dt>
<dd><p>Numeric (default: 1). Path-sized logit parameter (beta_PSL). Only used for PSL method.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments (currently ignored).</p></dd>


<dt id="arg-detour-max">detour.max<a class="anchor" aria-label="anchor" href="#arg-detour-max"></a></dt>
<dd><p>Numeric (default: 1.5). Maximum detour factor for alternative routes (applied to shortest paths cost). Only used for PSL method. This is a key parameter controlling the execution time of the algorithm: considering more routes (higher <code>detour.max</code>) substantially increases computation time.</p></dd>


<dt id="arg-angle-max">angle.max<a class="anchor" aria-label="anchor" href="#arg-angle-max"></a></dt>
<dd><p>Numeric (default: 90). Maximum detour angle (in degrees, two sided). Only used for PSL method. I.e., nodes not within this angle measured against a straight line from origin to destination node will not be considered for detours.</p></dd>


<dt id="arg-unique-cost">unique.cost<a class="anchor" aria-label="anchor" href="#arg-unique-cost"></a></dt>
<dd><p>Logical (default: TRUE). Deduplicates paths based on the total cost prior to generating them. Only used for PSL method. Since multiple 'intermediate nodes' may be on the same path, there is likely a significant number of duplicate paths which this option removes.</p></dd>


<dt id="arg-npaths-max">npaths.max<a class="anchor" aria-label="anchor" href="#arg-npaths-max"></a></dt>
<dd><p>Integer (default: Inf). Maximum number of paths to compute per OD-pair. Only used for PSL method. If the number of paths exceeds this number, a random sample will be taken from all but the shortest path.</p></dd>


<dt id="arg-dmat-max-size">dmat.max.size<a class="anchor" aria-label="anchor" href="#arg-dmat-max-size"></a></dt>
<dd><p>Integer (default: 1e4^2). Maximum size of distance matrices (both shortest paths and geodesic) to precompute. If smaller than <code>n_nodes^2</code>, then the full matrix is precomputed. Otherwise, it is computed in chunks as needed, where each chunk has <code>dmat.max.size</code> elements. Only used for PSL method.</p></dd>


<dt id="arg-return-extra">return.extra<a class="anchor" aria-label="anchor" href="#arg-return-extra"></a></dt>
<dd><p>Character vector specifying additional results to return. Options include:
<code>"graph"</code>, <code>"paths"</code>, <code>"edges"</code> (PSL only),
<code>"counts"</code>, <code>"costs"</code>, and <code>"weights"</code> (PSL only).
For AoN: <code>"paths"</code> returns a list of shortest paths (one integer vector per OD pair),
<code>"costs"</code> returns a numeric vector of shortest path costs, and <code>"counts"</code> returns a global integer vector of edge traversal counts.
Use <code>"all"</code> to return all available extra results for the selected method.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical (default: TRUE). Show progress bar and intermediate steps completion status?</p></dd>


<dt id="arg-nthreads">nthreads<a class="anchor" aria-label="anchor" href="#arg-nthreads"></a></dt>
<dd><p>Integer (default: 1L). Number of threads (daemons) to use for parallel processing with <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></code>. Should not exceed the number of logical processors.</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>An object of class <code>flownet</code>, typically returned by <code>run_assignment</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list of class <code>"flownet"</code> containing:</p><ul><li><p><code>call</code> - The function call</p></li>
<li><p><code>final_flows</code> - Numeric vector of assigned flows for each edge (same length as <code>nrow(graph_df)</code>)</p></li>
<li><p><code>od_pairs_used</code> - Indices of OD pairs with valid flows</p></li>
<li><p>Additional elements as specified in <code>return.extra</code>:</p><ul><li><p><code>graph</code> - The igraph graph object</p></li>
<li><p><code>paths</code> - For PSL: list of lists (multiple routes per OD pair); for AoN: list of integer vectors (one shortest path per OD pair)</p></li>
<li><p><code>edges</code> - List of edge indices used for each OD pair (PSL only)</p></li>
<li><p><code>edge_counts</code> - For PSL: list of edge visit counts per OD pair; for AoN: integer vector of global edge traversal counts</p></li>
<li><p><code>path_costs</code> - For PSL: list of path costs per OD pair; for AoN: numeric vector of shortest path costs</p></li>
<li><p><code>path_weights</code> - List of path weights (probabilities) for each OD pair (PSL only)</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function performs traffic assignment using one of two methods:</p>
<p><strong>All-or-Nothing (AoN) Method:</strong>
A simple assignment method that assigns all flow from each OD pair to the single shortest path.
This is much faster than PSL but does not consider route alternatives or overlaps.
Parameters <code>detour.max</code>, <code>angle.max</code>, <code>unique.cost</code>, <code>npaths.max</code>,
<code>beta</code>, and <code>dmat.max.size</code> are ignored for AoN.</p>
<p><strong>Path-Sized Logit (PSL) Method:</strong>
A more sophisticated assignment method that considers multiple alternative routes:</p><ul><li><p>Creates a graph from <code>graph_df</code> using igraph, normalizing node IDs internally</p></li>
<li><p>Computes shortest path distance matrix for all node pairs (chunkwise if <code>dmat.max.size &lt; n_nodes^2</code>)</p></li>
<li><p>For each origin-destination pair in <code>od_matrix_long</code>:</p><ul><li><p>Identifies alternative routes (detours) that are within <code>detour.max</code> of shortest path cost. This is done by considering all other nodes and adding the shortest paths costs from origin node to an intermediate node (any other node) and from intermediate node to destination node. If <code>angle.max</code> is specified, filters detours to those within the specified angle from origin to destination. This means we only consider intermediate nodes that are roughly 'in the direction' of the destination node, and also not further away in terms of geodesic distance. If also <code>unique.cost = TRUE</code>, duplicate paths are removed based on the total cost. Thus, using only the shortest-paths-cost matrix and a matrix of the geodesic distances of the nodes (if <code>is.finite(angle.max)</code>), the algorithm pre-selects unique paths that are plausible both in terms of detour factor (cost) and direction before actually computing them. This speeds up route enumeration and PSL computations considerably.</p></li>
<li><p>Finds shortest paths from origin to intermediate nodes and from intermediate nodes to destination</p></li>
<li><p>Filters paths to remove those with duplicate edges, i.e., where the intermediate node is approached and departed from via the same edge(s).</p></li>
<li><p>Computes path-sized logit probabilities accounting for route overlap</p></li>
<li><p>Assigns flows to edges based on probabilities weighted by route overlap</p></li>
</ul></li>
<li><p>Returns results including final flows and optionally additional information</p></li>
</ul><p>The path-sized logit model accounts for route overlap by adjusting probabilities based on
the number of alternative routes using each edge. Flows are assigned proportionally to
the computed probabilities. The model uses the parameter <code>beta</code> to control the
sensitivity to route overlap.</p>
<p>When <code>angle.max</code> is specified and <code>graph_df</code> contains coordinate columns
(<code>FX</code>, <code>FY</code>, <code>TX</code>, <code>TY</code>), the function uses geographic distance
calculations to restrict detours to those within the specified angle, improving
computational efficiency and route realism.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="flownet-package.html">flownet-package</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/flownet/">flownet</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load existing network edges (exclude proposed new links)</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span> <span class="op">&lt;-</span> <span class="va">africa_network</span><span class="op">[</span><span class="op">!</span><span class="va">africa_network</span><span class="op">$</span><span class="va">add</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert to graph (use atomic_elem to drop sf geometry, qDF for data.frame)</span></span></span>
<span class="r-in"><span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu">collapse</span><span class="fu">::</span><span class="fu"><a href="https://fastverse.org/collapse/reference/extract_list.html" class="external-link">atomic_elem</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">collapse</span><span class="fu">::</span><span class="fu"><a href="https://fastverse.org/collapse/reference/quick-conversion.html" class="external-link">qDF</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="nodes_from_graph.html">nodes_from_graph</a></span><span class="op">(</span><span class="va">graph</span>, sf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Map cities/ports to nearest network nodes</span></span></span>
<span class="r-in"><span><span class="va">nearest_nodes</span> <span class="op">&lt;-</span> <span class="va">nodes</span><span class="op">$</span><span class="va">node</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">nodes</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simple gravity-based OD matrix</span></span></span>
<span class="r-in"><span><span class="va">od_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span>, <span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e12</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nearest_nodes</span>, <span class="va">nearest_nodes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">od_matrix_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="melt_od_matrix.html">melt_od_matrix</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Run Traffic Assignment (All-or-Nothing method)</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">run_assignment</span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_long</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span></span>
<span class="r-in"><span>                         method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Visualize Results</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span><span class="op">$</span><span class="va">final_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">[</span><span class="st">"final_flows_log10"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

