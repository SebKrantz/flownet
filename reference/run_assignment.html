<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run Traffic Assignment — run_assignment • flownet</title><!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Run Traffic Assignment — run_assignment"><meta name="description" content="Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods."><meta property="og:description" content="Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods."><meta property="og:image" content="https://sebkrantz.github.io/flownet/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flownet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/flownet" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run Traffic Assignment</h1>
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/flownet/blob/master/R/assignment.R" class="external-link"><code>R/assignment.R</code></a></small>
      <div class="d-none name"><code>run_assignment.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Assign traffic flows to network edges using either Path-Sized Logit (PSL)
  or All-or-Nothing (AoN) assignment methods.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_assignment</span><span class="op">(</span></span>
<span>  <span class="va">graph_df</span>,</span>
<span>  <span class="va">od_matrix_long</span>,</span>
<span>  directed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cost.column <span class="op">=</span> <span class="st">"cost"</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PSL"</span>, <span class="st">"AoN"</span><span class="op">)</span>,</span>
<span>  beta <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  detour.max <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  angle.max <span class="op">=</span> <span class="fl">90</span>,</span>
<span>  unique.cost <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  npaths.max <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  dmat.max.size <span class="op">=</span> <span class="fl">10000</span><span class="op">^</span><span class="fl">2</span>,</span>
<span>  return.extra <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nthreads <span class="op">=</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'flownet'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-graph-df">graph_df<a class="anchor" aria-label="anchor" href="#arg-graph-df"></a></dt>
<dd><p>A data.frame with columns <code>from</code>, <code>to</code>, and optionally a cost column.
Represents the network graph with edges between nodes.</p></dd>


<dt id="arg-od-matrix-long">od_matrix_long<a class="anchor" aria-label="anchor" href="#arg-od-matrix-long"></a></dt>
<dd><p>A data.frame with columns <code>from</code>, <code>to</code>, and <code>flow</code>.
Represents the origin-destination matrix in long format with flow values.</p></dd>


<dt id="arg-directed">directed<a class="anchor" aria-label="anchor" href="#arg-directed"></a></dt>
<dd><p>Logical (default: FALSE). Whether the graph is directed.</p></dd>


<dt id="arg-cost-column">cost.column<a class="anchor" aria-label="anchor" href="#arg-cost-column"></a></dt>
<dd><p>Character string (default: "cost") or numeric vector. Name of the cost column
in <code>graph_df</code>, or a numeric vector of edge costs with length equal to <code>nrow(graph_df)</code>.
The cost values are used to compute shortest paths and determine route probabilities.</p></dd>


<dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>Character string (default: "PSL"). Assignment method:</p><ul><li><p><code>"PSL"</code>: Path-Sized Logit model considering multiple routes with overlap correction</p></li>
<li><p><code>"AoN"</code>: All-or-Nothing assignment, assigns all flow to the shortest path (faster but no route alternatives)</p></li>
</ul></dd>


<dt id="arg-beta">beta<a class="anchor" aria-label="anchor" href="#arg-beta"></a></dt>
<dd><p>Numeric (default: 1). Path-sized logit parameter (beta_PSL). Only used for PSL method.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments (currently ignored).</p></dd>


<dt id="arg-detour-max">detour.max<a class="anchor" aria-label="anchor" href="#arg-detour-max"></a></dt>
<dd><p>Numeric (default: 1.5). Maximum detour factor for alternative routes (applied to shortest paths cost). Only used for PSL method. This is a key parameter controlling the execution time of the algorithm: considering more routes (higher <code>detour.max</code>) substantially increases computation time.</p></dd>


<dt id="arg-angle-max">angle.max<a class="anchor" aria-label="anchor" href="#arg-angle-max"></a></dt>
<dd><p>Numeric (default: 90). Maximum detour angle (in degrees, two sided). Only used for PSL method. I.e., nodes not within this angle measured against a straight line from origin to destination node will not be considered for detours.</p></dd>


<dt id="arg-unique-cost">unique.cost<a class="anchor" aria-label="anchor" href="#arg-unique-cost"></a></dt>
<dd><p>Logical (default: TRUE). Deduplicates paths based on the total cost prior to generating them. Only used for PSL method. Since multiple 'intermediate nodes' may be on the same path, there is likely a significant number of duplicate paths which this option removes.</p></dd>


<dt id="arg-npaths-max">npaths.max<a class="anchor" aria-label="anchor" href="#arg-npaths-max"></a></dt>
<dd><p>Integer (default: Inf). Maximum number of paths to compute per OD-pair. Only used for PSL method. If the number of paths exceeds this number, a random sample will be taken from all but the shortest path.</p></dd>


<dt id="arg-dmat-max-size">dmat.max.size<a class="anchor" aria-label="anchor" href="#arg-dmat-max-size"></a></dt>
<dd><p>Integer (default: 1e4^2). Maximum size of distance matrices (both shortest paths and geodesic) to precompute. If smaller than <code>n_nodes^2</code>, then the full matrix is precomputed. Otherwise, it is computed in chunks as needed, where each chunk has <code>dmat.max.size</code> elements. Only used for PSL method.</p></dd>


<dt id="arg-return-extra">return.extra<a class="anchor" aria-label="anchor" href="#arg-return-extra"></a></dt>
<dd><p>Character vector specifying additional results to return.
  Use <code>"all"</code> to return all available extras for the selected method.</p>
<p></p><table class="table table"><tr><td><strong>Option</strong></td><td><strong>PSL</strong></td><td><strong>AoN</strong></td><td><strong>Description</strong></td></tr><tr><td><code>"graph"</code></td><td>Yes</td><td>Yes</td><td>The igraph graph object</td></tr><tr><td><code>"paths"</code></td><td>Yes</td><td>Yes</td><td>PSL: list of lists of edge indices (multiple routes per OD); AoN: list of edge index vectors (one path per OD)</td></tr><tr><td><code>"edges"</code></td><td>Yes</td><td>No</td><td>List of edge indices used for each OD pair</td></tr><tr><td><code>"counts"</code></td><td>Yes</td><td>Yes</td><td>PSL: list of edge visit counts per OD; AoN: integer vector of global edge traversal counts</td></tr><tr><td><code>"costs"</code></td><td>Yes</td><td>Yes</td><td>PSL: list of path costs per OD; AoN: numeric vector of shortest path costs</td></tr><tr><td><code>"weights"</code></td><td>Yes</td><td>No</td><td>List of path weights (probabilities) for each OD pair</td></tr></table></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical (default: TRUE). Show progress bar and intermediate steps completion status?</p></dd>


<dt id="arg-nthreads">nthreads<a class="anchor" aria-label="anchor" href="#arg-nthreads"></a></dt>
<dd><p>Integer (default: 1L). Number of threads (daemons) to use for parallel processing with <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></code>. Should not exceed the number of logical processors.</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>An object of class <code>flownet</code>, typically returned by <code>run_assignment</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list of class <code>"flownet"</code> containing:</p><ul><li><p><code>call</code> - The function call</p></li>
<li><p><code>final_flows</code> - Numeric vector of assigned flows for each edge (same length as <code>nrow(graph_df)</code>)</p></li>
<li><p><code>od_pairs_used</code> - Indices of OD pairs with valid flows</p></li>
<li><p>Additional elements as specified in <code>return.extra</code>:</p><ul><li><p><code>graph</code> - The igraph graph object</p></li>
<li><p><code>paths</code> - For PSL: list of lists of edge indices (multiple routes per OD pair); for AoN: list of edge index vectors (one shortest path per OD pair)</p></li>
<li><p><code>edges</code> - List of edge indices used for each OD pair (PSL only)</p></li>
<li><p><code>edge_counts</code> - For PSL: list of edge visit counts per OD pair; for AoN: integer vector of global edge traversal counts</p></li>
<li><p><code>path_costs</code> - For PSL: list of path costs per OD pair; for AoN: numeric vector of shortest path costs</p></li>
<li><p><code>path_weights</code> - List of path weights (probabilities) for each OD pair (PSL only)</p></li>
</ul></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function performs traffic assignment using one of two methods:
<strong>All-or-Nothing (AoN)</strong> is fast but assigns all flow to a single shortest path;
<strong>Path-Sized Logit (PSL)</strong> considers multiple routes with overlap correction for
more realistic flow distribution.</p>
<div class="section">
<h3 id="all-or-nothing-aon-method">All-or-Nothing (AoN) Method<a class="anchor" aria-label="anchor" href="#all-or-nothing-aon-method"></a></h3>
<p>A simple assignment method that assigns all flow from each OD pair to the single shortest path.
This is much faster than PSL but does not consider route alternatives or overlaps.
Parameters <code>detour.max</code>, <code>angle.max</code>, <code>unique.cost</code>, <code>npaths.max</code>,
<code>beta</code>, and <code>dmat.max.size</code> are ignored for AoN.</p>
</div>

<div class="section">
<h3 id="path-sized-logit-psl-method">Path-Sized Logit (PSL) Method<a class="anchor" aria-label="anchor" href="#path-sized-logit-psl-method"></a></h3>
<p>A more sophisticated assignment method that considers multiple alternative routes and
accounts for route overlap when assigning flows. The PSL model adjusts choice probabilities
based on how much each route overlaps with other alternatives, preventing overestimation
of flow on shared segments. The <code>beta</code> parameter controls the sensitivity to overlap.</p>
</div>

<div class="section">
<h3 id="psl-model-formulation">PSL Model Formulation<a class="anchor" aria-label="anchor" href="#psl-model-formulation"></a></h3>
<p>The probability \(P_k\) of choosing route \(k\) from the set of alternatives \(K\) is:
$$P_k = \frac{e^{V_k}}{\sum_{j \in K} e^{V_j}}$$
where the utility \(V_k\) is defined as:
$$V_k = -C_k + \beta_{PSL} \ln(PS_k)$$
Here \(C_k\) is the generalized cost of route \(k\), \(\beta_{PSL}\) is the
path-size parameter (the <code>beta</code> argument), and \(PS_k\) is the path-size factor.</p>
<p>The path-size factor quantifies route uniqueness:
$$PS_k = \frac{1}{C_k} \sum_{a \in \Gamma_k} \frac{c_a}{\delta_a}$$
where \(\Gamma_k\) is the set of edges in path \(k\), \(c_a\) is the cost of
edge \(a\), and \(\delta_a\) is the number of alternative routes using edge \(a\).</p>
<p>If a path is unique (\(\delta_a = 1\) for all edges), then \(PS_k = 1\) and the
model reduces to standard MNL. For overlapping routes, \(PS_k &lt; 1\) and
\(\ln(PS_k) &lt; 0\), so a positive <code>beta</code> penalizes overlap. Higher <code>beta</code>
values strengthen penalization; <code>beta = 0</code> gives standard MNL behavior.</p>
<p>For more information about the PSL model consult some of the references below.</p>
</div>

<div class="section">
<h3 id="route-enumeration-algorithm">Route Enumeration Algorithm<a class="anchor" aria-label="anchor" href="#route-enumeration-algorithm"></a></h3>
<p>For each origin-destination pair, the algorithm identifies alternative routes as follows:</p><ol><li><p>Compute the shortest path cost from origin to destination.</p></li>
<li><p>For each potential intermediate node, calculate the total cost of going
        origin -&gt; intermediate -&gt; destination.</p></li>
<li><p>Keep only routes where total cost is within <code>detour.max</code> times the
        shortest path cost.</p></li>
<li><p>If <code>angle.max</code> is specified, filter to intermediate nodes that lie
        roughly in the direction of the destination (within the specified angle).</p></li>
<li><p>If <code>unique.cost = TRUE</code>, remove duplicate routes based on total cost.</p></li>
<li><p>Compute the actual paths and filter out those with duplicate edges
        (where the intermediate node is approached and departed via the same edge).</p></li>
</ol><p>This pre-selection using distance matrices speeds up route enumeration considerably
by avoiding computation of implausible paths.</p>
</div>

<div class="section">
<h3 id="coordinate-based-filtering">Coordinate-Based Filtering<a class="anchor" aria-label="anchor" href="#coordinate-based-filtering"></a></h3>
<p>When <code>angle.max</code> is specified and <code>graph_df</code> contains coordinate columns
(<code>FX</code>, <code>FY</code>, <code>TX</code>, <code>TY</code>), the function uses geographic distance
calculations to restrict detours. Only intermediate nodes that are (a) closer to the
origin than the destination is, and (b) within the specified angle from the
origin-destination line are considered. This improves both computational efficiency
and route realism by excluding geographically implausible detours.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Ben-Akiva, M., &amp; Bierlaire, M. (1999). Discrete choice methods and their
applications to short term travel decisions. In R. W. Hall (Ed.), <em>Handbook
of Transportation Science</em> (pp. 5-33). Springer US. <a href="https://doi.org/10.1007/978-1-4615-5203-1_2" class="external-link">doi:10.1007/978-1-4615-5203-1_2</a></p>
<p>Cascetta, E. (2001). <em>Transportation systems engineering: Theory and methods</em>.
Springer.</p>
<p>Ben-Akiva, M., &amp; Lerman, S. R. (1985). <em>Discrete choice analysis: Theory and
application to travel demand</em>. The MIT Press.</p>
<p>Ramming, M. S. (2002). <em>Network knowledge and route choice</em> (Doctoral
dissertation). Massachusetts Institute of Technology.</p>
<p>Prato, C. G. (2009). Route choice modeling: Past, present and future research
directions. <em>Journal of Choice Modelling, 2</em>(1), 65-100. <a href="https://doi.org/10.1016/S1755-5345%2813%2970005-8" class="external-link">doi:10.1016/S1755-5345(13)70005-8</a></p>
<p>AequilibiaE Python Documentation: https://www.aequilibrae.com/develop/python/route_choice/path_size_logit.html</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="flownet-package.html">flownet-package</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/flownet/">flownet</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fastverse.org/collapse/" class="external-link">collapse</a></span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> collapse 2.1.6, see ?`collapse-package` or ?`collapse-documentation`</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘collapse’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:stats’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     D</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load existing network edges (exclude proposed new links)</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span> <span class="op">&lt;-</span> <span class="va">africa_network</span><span class="op">[</span><span class="op">!</span><span class="va">africa_network</span><span class="op">$</span><span class="va">add</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert to graph (use atomic_elem to drop sf geometry, qDF for data.frame)</span></span></span>
<span class="r-in"><span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/extract_list.html" class="external-link">atomic_elem</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/quick-conversion.html" class="external-link">qDF</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="nodes_from_graph.html">nodes_from_graph</a></span><span class="op">(</span><span class="va">graph</span>, sf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Map cities/ports to nearest network nodes</span></span></span>
<span class="r-in"><span><span class="va">nearest_nodes</span> <span class="op">&lt;-</span> <span class="va">nodes</span><span class="op">$</span><span class="va">node</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">nodes</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Simple gravity-based OD matrix</span></span></span>
<span class="r-in"><span><span class="va">od_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span>, <span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e12</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nearest_nodes</span>, <span class="va">nearest_nodes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">od_matrix_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="melt_od_matrix.html">melt_od_matrix</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run Traffic Assignment (All-or-Nothing method)</span></span></span>
<span class="r-in"><span><span class="va">result_aon</span> <span class="op">&lt;-</span> <span class="fu">run_assignment</span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_long</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span></span>
<span class="r-in"><span>                             method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Created graph with 1379 nodes and 2344 edges...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 495 OD-pairs have zero or non-finite flow values and will be skipped...</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_aon</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> FlowNet object</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_long,      cost.column = "duration", method = "AoN", return.extra = "all") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of nodes: 1379 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of edges: 2344 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of simulations/OD-pairs: 204714 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path length in edges (SD): 34.99213  (19.56615)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of visits per edge (SD): 3056.049  (5875.129)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path cost (SD): 4345.631  (2253.376)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Final flows summary statistics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      N  Ndist     Mean       SD  Min       Max  Skew   Kurt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2344   2017  2187.89  4553.86    0  37250.26  3.49  18.49</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1%  5%   10%    25%     50%      75%   90%       95%       99%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    0   0  1.08  36.57  295.39  1662.86  7581  11386.38  20188.24</span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Run Traffic Assignment (Path-Sized Logit method)</span></span></span>
<span class="r-in"><span><span class="co"># Note: PSL is slower but produces more realistic flow distribution</span></span></span>
<span class="r-in"><span><span class="va">result_psl</span> <span class="op">&lt;-</span> <span class="fu">run_assignment</span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_long</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span></span>
<span class="r-in"><span>                             method <span class="op">=</span> <span class="st">"PSL"</span>, nthreads <span class="op">=</span> <span class="fl">1L</span>,</span></span>
<span class="r-in"><span>                             return.extra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"edges"</span>, <span class="st">"counts"</span>, <span class="st">"costs"</span>, <span class="st">"weights"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Created graph with 1379 nodes and 2344 edges...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed distance matrix of dimensions 1379 x 1379 ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 495 OD-pairs have zero or non-finite flow values and will be skipped...</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_psl</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> FlowNet object</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_long,      cost.column = "duration", method = "PSL", return.extra = c("edges",          "counts", "costs", "weights"), nthreads = 1L) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of edges: 2344 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of simulations/OD-pairs: 204714 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of edges utilized per simulation (SD): 561.081  (435.3152)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of visits per edge (SD): 11.62403  (23.3552)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path cost (SD): 5019.838  (554.6268)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path weight (SD): 0.0293314  (0.0879165)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Final flows summary statistics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      N  Ndist     Mean       SD  Min       Max  Skew   Kurt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2344   2259  2188.73  4541.72    0  37246.92  3.48  18.43</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1%    5%   10%    25%     50%      75%      90%       95%       99%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    0  0.05  1.62  39.28  301.48  1677.97  7573.77  11419.34  19460.79</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Visualize AoN Results</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span><span class="op">$</span><span class="va">final_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result_psl</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">[</span><span class="st">"final_flows_log10"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"PSL Assignment"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="run_assignment-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># --- Trade Flow Disaggregation Example ---</span></span></span>
<span class="r-in"><span><span class="co"># Disaggregate country-level trade to city-level using population shares</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute each city's share of its country's population</span></span></span>
<span class="r-in"><span><span class="va">city_pop</span> <span class="op">&lt;-</span> <span class="va">africa_cities_ports</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/extract_list.html" class="external-link">atomic_elem</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/quick-conversion.html" class="external-link">qDF</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/ftransform.html" class="external-link">fcompute</a></span><span class="op">(</span>node <span class="op">=</span> <span class="va">nearest_nodes</span>,</span></span>
<span class="r-in"><span>           city <span class="op">=</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/qF.html" class="external-link">qF</a></span><span class="op">(</span><span class="va">city_country</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>           pop_share <span class="op">=</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/fsum.html" class="external-link">fsum</a></span><span class="op">(</span><span class="va">population</span>, <span class="va">iso3</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>           keep <span class="op">=</span> <span class="st">"iso3"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Aggregate trade to country-country level and disaggregate to cities</span></span></span>
<span class="r-in"><span><span class="va">trade_agg</span> <span class="op">&lt;-</span> <span class="va">africa_trade</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/collap.html" class="external-link">collap</a></span><span class="op">(</span><span class="va">quantity</span> <span class="op">~</span> <span class="va">iso3_o</span> <span class="op">+</span> <span class="va">iso3_d</span>, <span class="va">fsum</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">od_matrix_trade</span> <span class="op">&lt;-</span> <span class="va">trade_agg</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/join.html" class="external-link">join</a></span><span class="op">(</span><span class="va">city_pop</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/small-helpers.html" class="external-link">add_stub</a></span><span class="op">(</span><span class="st">"_o"</span>, <span class="cn">FALSE</span><span class="op">)</span>, multiple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/join.html" class="external-link">join</a></span><span class="op">(</span><span class="va">city_pop</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fastverse.org/collapse/reference/small-helpers.html" class="external-link">add_stub</a></span><span class="op">(</span><span class="st">"_d"</span>, <span class="cn">FALSE</span><span class="op">)</span>, multiple <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/ftransform.html" class="external-link">fmutate</a></span><span class="op">(</span>flow <span class="op">=</span> <span class="va">quantity</span> <span class="op">*</span> <span class="va">pop_share_o</span> <span class="op">*</span> <span class="va">pop_share_d</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/frename.html" class="external-link">frename</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">node_o</span>, to <span class="op">=</span> <span class="va">node_d</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://fastverse.org/collapse/reference/fsubset.html" class="external-link">fsubset</a></span><span class="op">(</span><span class="va">flow</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">from</span> <span class="op">!=</span> <span class="va">to</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> left join: trade_agg[iso3_o] 1971/1971 (100%) &lt;41.94:9.62&gt; y[iso3_o] 452/453 (99.8%)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> left join: x[iso3_d] 19685/19685 (100%) &lt;418.83:9.62&gt; y[iso3_d] 452/453 (99.8%)</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run AoN assignment with trade flows</span></span></span>
<span class="r-in"><span><span class="va">result_trade_aon</span> <span class="op">&lt;-</span> <span class="fu">run_assignment</span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_trade</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span></span>
<span class="r-in"><span>                                   method <span class="op">=</span> <span class="st">"AoN"</span>, return.extra <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Created graph with 1379 nodes and 2344 edges...</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_trade_aon</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> FlowNet object</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_trade,      cost.column = "duration", method = "AoN", return.extra = "all") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of nodes: 1379 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of edges: 2344 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of simulations/OD-pairs: 189020 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path length in edges (SD): 36.15387  (19.23456)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of visits per edge (SD): 2915.445  (5685.838)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path cost (SD): 4477.602  (2187.799)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Final flows summary statistics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      N  Ndist         Mean           SD  Min          Max  Skew   Kurt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2344   1864  1'273306.07  2'915489.75    0  21'964576.8   3.7  18.51</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1%  5%  10%       25%        50%        75%          90%          95%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    0   0    0  17330.95  142839.71  911817.37  3'624008.55  6'948734.38</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           99%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   14'969459.2</span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># Visualize trade flow results</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span><span class="op">$</span><span class="va">trade_flows_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result_trade_aon</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">[</span><span class="st">"trade_flows_log10"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Trade Flow Assignment (AoN)"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="run_assignment-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run PSL assignment with trade flows (nthreads can be increased for speed)</span></span></span>
<span class="r-in"><span><span class="va">result_trade_psl</span> <span class="op">&lt;-</span> <span class="fu">run_assignment</span><span class="op">(</span><span class="va">graph</span>, <span class="va">od_matrix_trade</span>, cost.column <span class="op">=</span> <span class="st">"duration"</span>,</span></span>
<span class="r-in"><span>                                   method <span class="op">=</span> <span class="st">"PSL"</span>, nthreads <span class="op">=</span> <span class="fl">1L</span>,</span></span>
<span class="r-in"><span>                                   return.extra <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"edges"</span>, <span class="st">"counts"</span>, <span class="st">"costs"</span>, <span class="st">"weights"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Created graph with 1379 nodes and 2344 edges...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Computed distance matrix of dimensions 1379 x 1379 ...</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_trade_psl</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> FlowNet object</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: run_assignment(graph_df = graph, od_matrix_long = od_matrix_trade,      cost.column = "duration", method = "PSL", return.extra = c("edges",          "counts", "costs", "weights"), nthreads = 1L) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of edges: 2344 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Number of simulations/OD-pairs: 189020 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of edges utilized per simulation (SD): 582.2353  (433.1455)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average number of visits per edge (SD): 11.98732  (24.20449)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path cost (SD): 5171.393  (567.9297)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Average path weight (SD): 0.01955912  (0.07892114)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Final flows summary statistics:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      N  Ndist         Mean           SD  Min          Max  Skew   Kurt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2344   2226  1'273430.15  2'909962.24    0  21'903042.7   3.7  18.53</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1%  5%    10%       25%        50%        75%          90%          95%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    0   0  71.23  17584.12  145086.78  908973.72  3'619965.69  6'948795.48</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           99%</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   14'978197.2</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compare PSL vs AoN: PSL typically shows more distributed flows</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span><span class="op">$</span><span class="va">trade_flows_psl_log10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">result_trade_psl</span><span class="op">$</span><span class="va">final_flows</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">[</span><span class="st">"trade_flows_psl_log10"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Trade Flow Assignment (PSL)"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="run_assignment-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

