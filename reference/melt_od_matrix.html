<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Melt Origin-Destination Matrix to Long Format — melt_od_matrix • flownet</title><!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Melt Origin-Destination Matrix to Long Format — melt_od_matrix"><meta name="description" content="Convert an origin-destination (OD) matrix to a long-format data frame
  with columns from, to, and flow."><meta property="og:description" content="Convert an origin-destination (OD) matrix to a long-format data frame
  with columns from, to, and flow."><meta property="og:image" content="https://sebkrantz.github.io/flownet/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flownet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Documentation</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://sebkrantz.github.io/Rblog/">Blog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SebKrantz/flownet" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Melt Origin-Destination Matrix to Long Format</h1>
      <small class="dont-index">Source: <a href="https://github.com/SebKrantz/flownet/blob/v0.1.2/R/utils.R" class="external-link"><code>R/utils.R</code></a></small>
      <div class="d-none name"><code>melt_od_matrix.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Convert an origin-destination (OD) matrix to a long-format data frame
  with columns <code>from</code>, <code>to</code>, and <code>flow</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">melt_od_matrix</span><span class="op">(</span><span class="va">od_matrix</span>, nodes <span class="op">=</span> <span class="cn">NULL</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-od-matrix">od_matrix<a class="anchor" aria-label="anchor" href="#arg-od-matrix"></a></dt>
<dd><p>A numeric matrix with origin-destination flows. Rows represent origins,
columns represent destinations. The matrix should be square (same number of rows and columns).</p></dd>


<dt id="arg-nodes">nodes<a class="anchor" aria-label="anchor" href="#arg-nodes"></a></dt>
<dd><p>(Optional) Numeric or integer vector of node IDs in the graph matching the rows
and columns of the matrix. If provided, must have length equal to both <code>nrow(od_matrix)</code>
and <code>ncol(od_matrix)</code>. When <code>nodes</code> is provided, these IDs are used directly,
ignoring row and column names. This is particularly useful when mapping zone-based OD matrices
to graph node IDs (e.g., using <code><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></code> to find nearest graph nodes).
If omitted, row and column names (if present) will be used as node IDs, coerced to integer
if possible. If names are not available or cannot be coerced to integer, sequential integers
will be used.</p></dd>


<dt id="arg-sort">sort<a class="anchor" aria-label="anchor" href="#arg-sort"></a></dt>
<dd><p>Sort long OD-matrix in ascending order of from and to columns. This can have computational benefits, e.g., when multithreading with <code>method = "AoN"</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data frame with columns:</p><ul><li><p><code>from</code> - Origin node ID (integer)</p></li>
<li><p><code>to</code> - Destination node ID (integer)</p></li>
<li><p><code>flow</code> - Flow value (numeric)</p></li>
</ul><p>Only rows with finite, positive flow values are included.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function converts a square OD matrix to long format, which is required by
<code><a href="run_assignment.html">run_assignment()</a></code>. The behavior depends on whether <code>nodes</code>
is provided:</p>
<p><strong>When <code>nodes</code> is provided:</strong></p><ul><li><p>The <code>nodes</code> vector is used directly as node IDs for both origins and destinations</p></li>
<li><p>Row and column names are ignored (but must match if both are present)</p></li>
<li><p>This is the recommended approach when working with zone-based OD matrices that need to be
    mapped to graph nodes, as it ensures the node IDs match those in the graph</p></li>
</ul><p><strong>When <code>nodes</code> is omitted:</strong></p><ul><li><p>Row and column names are extracted from the matrix (if available)</p></li>
<li><p>Names are coerced to integer if possible; if coercion fails or names are missing,
    sequential integers are used</p></li>
<li><p>This approach works well when the matrix row/column names already correspond to graph node IDs</p></li>
</ul><p>In both cases, the function:</p><ul><li><p>Creates a long-format data frame with all origin-destination pairs</p></li>
<li><p>Filters out non-finite and zero flow values</p></li>
</ul><p>The function is useful for converting OD matrices to the long format required by
<code><a href="run_assignment.html">run_assignment()</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="africa_cities_ports.html">africa_cities_ports</a></code>, <code><a href="africa_network.html">africa_network</a></code>,
  <code><a href="nodes_from_graph.html">nodes_from_graph()</a></code>,
  <code><a href="run_assignment.html">run_assignment()</a></code>, <a href="flownet-package.html">flownet-package</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/flownet/">flownet</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load existing network and convert to graph</span></span></span>
<span class="r-in"><span><span class="va">africa_net</span> <span class="op">&lt;-</span> <span class="va">africa_network</span><span class="op">[</span><span class="op">!</span><span class="va">africa_network</span><span class="op">$</span><span class="va">add</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">graph</span> <span class="op">&lt;-</span> <span class="fu"><a href="linestrings_to_graph.html">linestrings_to_graph</a></span><span class="op">(</span><span class="va">africa_net</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="nodes_from_graph.html">nodes_from_graph</a></span><span class="op">(</span><span class="va">graph</span>, sf <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Map cities/ports to nearest network nodes</span></span></span>
<span class="r-in"><span><span class="va">nearest_nodes</span> <span class="op">&lt;-</span> <span class="va">nodes</span><span class="op">$</span><span class="va">node</span><span class="op">[</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html" class="external-link">st_nearest_feature</a></span><span class="op">(</span><span class="va">africa_cities_ports</span>, <span class="va">nodes</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 1: Simple gravity-based OD matrix</span></span></span>
<span class="r-in"><span><span class="va">od_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span>, <span class="va">africa_cities_ports</span><span class="op">$</span><span class="va">population</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e12</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nearest_nodes</span>, <span class="va">nearest_nodes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">od_long</span> <span class="op">&lt;-</span> <span class="fu">melt_od_matrix</span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_long</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   from to       flow</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    1  1 10.3925963</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    1  6  0.3804031</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    1  8  4.6445025</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    1 11  3.1488124</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    1 13  0.6058467</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    1 15  0.4982475</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 2: Using nodes argument (when matrix has zone IDs, not node IDs)</span></span></span>
<span class="r-in"><span><span class="co"># Here zones are 1:n_cities, nodes argument maps them to graph nodes</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">od_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span><span class="va">od_long2</span> <span class="op">&lt;-</span> <span class="fu">melt_od_matrix</span><span class="op">(</span><span class="va">od_mat</span>, nodes <span class="op">=</span> <span class="va">nearest_nodes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">od_long2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   from to       flow</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    1  1 10.3925963</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2    1  6  0.3804031</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3    1  8  4.6445025</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4    1 11  3.1488124</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5    1 13  0.6058467</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6    1 15  0.4982475</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Krantz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

