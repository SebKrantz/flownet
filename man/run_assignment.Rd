% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/assignment.R
\name{run_assignment}
\alias{run_assignment}
\alias{print.flowr}
\title{Run Traffic Assignment}
\usage{
run_assignment(
  graph_df,
  od_matrix_long,
  directed = FALSE,
  cost.column = "cost",
  method = "PSL",
  beta = 1,
  ...,
  detour.max = 1.5,
  angle.max = 90,
  return.extra = NULL,
  precompute.dmat = TRUE,
  verbose = TRUE,
  nthreads = 1L
)

\method{print}{flowr}(x, ...)
}
\arguments{
\item{graph_df}{A data.frame with columns \code{from}, \code{to}, and optionally a cost column.
Represents the network graph with edges between nodes.}

\item{od_matrix_long}{A data.frame with columns \code{from}, \code{to}, and \code{flow}.
Represents the origin-destination matrix in long format with flow values.}

\item{directed}{Logical (default: FALSE). Whether the graph is directed.}

\item{cost.column}{Character string (default: "cost") or numeric vector. Name of the cost column
in \code{graph_df}, or a numeric vector of edge costs with length equal to \code{nrow(graph_df)}.
The cost values are used to compute shortest paths and determine route probabilities.}

\item{method}{Character string (default: "PSL"). Assignment method. Currently only "PSL"
(Path-Sized Logit) is implemented.}

\item{beta}{Numeric (default: 1). Path-sized logit parameter (beta_PSL).}

\item{\dots}{Additional arguments (currently ignored).}

\item{detour.max}{Numeric (default: 1.5). Maximum detour factor for alternative routes (applied to shortest paths cost). This is a key parameter controlling the execution time of the algorithm: considering more routes (higher \code{detour.max}) substantially increases computation time.}

\item{angle.max}{Numeric (default: 90). Maximum detour angle (in degrees, two sided). I.e., nodes not within this angle measured against a straight line from origin to destination node will not be considered for detours.}

\item{return.extra}{Character vector specifying additional results to return. Options include:
\code{"graph"}, \code{"dmat"}, \code{"paths"} (most memory intensive), \code{"edges"}, \code{"counts"}, \code{"costs"}, and \code{"weights"}.
Use \code{"all"} to return all available extra results.}

\item{precompute.dmat}{Logical (default: TRUE). Should distance matrices be precomputed or computed on the fly.
The former is more memory intensive but dramatically speeds up the OD-iterations.}

\item{verbose}{Logical (default: TRUE). Show progress bar and intermediate steps completion status?}

\item{nthreads}{Integer (default: 1L). Number of threads (daemons) to use for parallel processing with \code{\link[mirai]{mirai}}. Should not exceed the number of logical processors.}

\item{x}{An object of class \code{flowr}, typically returned by \code{\link{run_assignment}}.}
}
\value{
A list of class \code{"flowr"} containing:
  \itemize{
    \item \code{call} - The function call
    \item \code{final_flows} - Numeric vector of assigned flows for each edge (same length as \code{nrow(graph_df)})
    \item \code{od_pairs_used} - Indices of OD pairs with valid flows
    \item Additional elements as specified in \code{return.extra}:
      \itemize{
        \item \code{graph} - The igraph graph object
        \item \code{dmat} - Distance matrix with node IDs as dimnames
        \item \code{paths} - List of paths for each OD pair
        \item \code{edges} - List of edge indices used for each OD pair
        \item \code{edge_counts} - List of edge visit counts for each OD pair
        \item \code{path_costs} - List of path costs for each OD pair
        \item \code{path_weights} - List of path weights (probabilities) for each OD pair
      }
  }
}
\description{
Assign traffic flows to network edges using path-sized logit (PSL) model.
}
\details{
This function performs traffic assignment using a path-sized logit (PSL) model:
\itemize{
  \item Creates a graph from \code{graph_df} using igraph, normalizing node IDs internally
  \item Optionally computes shortest path distance matrix for all node pairs (if \code{precompute.dmat = TRUE})
  \item For each origin-destination pair in \code{od_matrix_long}:
    \itemize{
      \item Identifies alternative routes (detours) that are within \code{detour.max} of shortest path cost
      \item If \code{angle.max} is specified, filters detours to those within the specified angle from origin to destination
      \item Finds shortest paths from origin to intermediate nodes and from intermediate nodes to destination
      \item Filters paths to remove those with duplicate edges
      \item Computes path-sized logit probabilities accounting for route overlap
      \item Assigns flows to edges based on probabilities weighted by route overlap
    }
  \item Returns results including final flows and optionally additional information
}

The path-sized logit model accounts for route overlap by adjusting probabilities based on
the number of alternative routes using each edge. Flows are assigned proportionally to
the computed probabilities. The model uses the parameter \code{beta} to control the
sensitivity to route overlap.

When \code{angle.max} is specified and \code{graph_df} contains coordinate columns
(\code{FX}, \code{FY}, \code{TX}, \code{TY}), the function uses geographic distance
calculations to restrict detours to those within the specified angle, improving
computational efficiency and route realism.
}
\examples{
library(flowr)
library(sf)

# Load Graph
graph <- linestrings_to_graph(network_gcc)
nodes <- nodes_from_graph(graph, sf = TRUE)

# Map Zones to Nodes
nearest_nodes <- nodes$node[st_nearest_feature(zones_gcc, nodes)]

# Process OD Matrix
od_matrix_long <- melt_od_matrix(od_matrices_gcc$container, nodes = nearest_nodes)

# Run Traffic Assignment
result <- run_assignment(graph, od_matrix_long, cost.column = "generalized_cost",
                         return.extra = "all")
print(result)

\dontrun{
# Visualize Results
network_gcc$final_flows_log10 <- log10(result$final_flows + 1)

mapview(network_gcc, zcol = "final_flows_log10",
        layer.name = "Container Flows (Log10)") +
mapview(zones_gcc, alpha = 0, cex = 3,
        col.regions = "red", alpha.regions = 0.8,
        layer.name = "Zone Nodes")
}

}
\seealso{
\link{flowr-package}
}
